name: Bump Scoop bucket manifest

on:
  workflow_run:
    workflows: ["release"]
    types: [completed]

permissions:
  contents: read

jobs:
  bump:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      BUCKET_REPO: fcrozetta/scoop-bucket
      MANIFEST_PATH: bucket/kubeforward.json
      TOOL: kubeforward

    steps:
      - name: Read version + Windows sha256 assets
        id: meta
        run: |
          set -euo pipefail
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          HEAD_REF="${{ github.event.workflow_run.head_branch }}"

          VERSION=""
          if [[ "${HEAD_REF}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            if git ls-remote --tags "https://github.com/${{ github.repository }}.git" \
              "refs/tags/${HEAD_REF}" "refs/tags/${HEAD_REF}^{}" \
              | awk -v sha="${HEAD_SHA}" '$1 == sha { found = 1 } END { exit(found ? 0 : 1) }'; then
              VERSION="${HEAD_REF}"
            else
              echo "workflow_run.head_branch (${HEAD_REF}) is semver but does not resolve to head SHA ${HEAD_SHA}" >&2
              exit 1
            fi
          fi

          if [[ -z "${VERSION}" ]]; then
            mapfile -t MATCHING_TAGS < <(
              git ls-remote --tags "https://github.com/${{ github.repository }}.git" \
                | awk -v sha="${HEAD_SHA}" '$1 == sha {
                    ref = $2
                    sub("^refs/tags/", "", ref)
                    sub("\\^\\{\\}$", "", ref)
                    if (ref ~ /^[0-9]+\.[0-9]+\.[0-9]+$/) print ref
                  }' \
                | sort -u
            )

            if [[ "${#MATCHING_TAGS[@]}" -eq 1 ]]; then
              VERSION="${MATCHING_TAGS[0]}"
            elif [[ "${#MATCHING_TAGS[@]}" -gt 1 ]]; then
              echo "Ambiguous semver tags for head SHA ${HEAD_SHA}: ${MATCHING_TAGS[*]}" >&2
              echo "workflow_run.head_branch=${HEAD_REF}" >&2
              exit 1
            fi
          fi

          if [[ -z "${VERSION}" || ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Unable to resolve semver release tag for workflow_run head SHA ${HEAD_SHA}" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "release_url=https://github.com/${{ github.repository }}/releases/tag/${VERSION}" >> "$GITHUB_OUTPUT"

          base="https://github.com/${{ github.repository }}/releases/download/${VERSION}"

          get_sha () {
            local suffix="$1"
            local url="${base}/${TOOL}-${VERSION}-${suffix}.zip.sha256"
            echo "Fetching ${url}" >&2
            local line
            line="$(curl -fsSL "${url}")"
            local sha
            sha="$(echo "${line}" | awk '{print $1}')"
            if [[ ! "${sha}" =~ ^[0-9a-fA-F]{64}$ ]]; then
              echo "Bad sha256 for ${suffix}: ${line}" >&2
              exit 1
            fi
            echo "${sha,,}"
          }

          sha_windows_x64="$(get_sha windows-x64)"
          sha_windows_arm64="$(get_sha windows-arm64)"

          {
            echo "sha_windows_x64=${sha_windows_x64}"
            echo "sha_windows_arm64=${sha_windows_arm64}"
          } >> "$GITHUB_OUTPUT"

      - name: Validate cross-repo token
        env:
          CROSS_REPO_TOKEN: ${{ secrets.PAT_BREW_SCOOP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -z "${CROSS_REPO_TOKEN}" ]]; then
            echo "Missing required secret: PAT_BREW_SCOOP_GITHUB_TOKEN." >&2
            exit 1
          fi

      - name: Checkout bucket repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.BUCKET_REPO }}
          token: ${{ secrets.PAT_BREW_SCOOP_GITHUB_TOKEN }}
          path: bucketrepo
          fetch-depth: 0

      - name: Patch manifest (version + arch hashes)
        working-directory: bucketrepo
        env:
          MANIFEST_PATH: ${{ env.MANIFEST_PATH }}
          VERSION: ${{ steps.meta.outputs.version }}
          SHA_WINDOWS_X64: ${{ steps.meta.outputs.sha_windows_x64 }}
          SHA_WINDOWS_ARM64: ${{ steps.meta.outputs.sha_windows_arm64 }}
        run: |
          set -euo pipefail
          test -f "${MANIFEST_PATH}"

          python3 - << 'PY'
          import json
          import os
          import sys

          path = os.environ["MANIFEST_PATH"]
          version = os.environ["VERSION"]
          sha_windows_x64 = os.environ["SHA_WINDOWS_X64"].lower()
          sha_windows_arm64 = os.environ["SHA_WINDOWS_ARM64"].lower()

          with open(path, "r", encoding="utf-8") as f:
            data = json.load(f)

          if not isinstance(data, dict):
            print("Manifest root must be a JSON object", file=sys.stderr)
            sys.exit(1)

          arch = data.get("architecture")
          if not isinstance(arch, dict):
            print("Manifest missing architecture object", file=sys.stderr)
            sys.exit(1)

          targets = {
            "64bit": ("windows-x64", sha_windows_x64),
            "arm64": ("windows-arm64", sha_windows_arm64),
          }

          for key, (suffix, sha) in targets.items():
            stanza = arch.get(key)
            if not isinstance(stanza, dict):
              print(f"Missing architecture stanza: {key}", file=sys.stderr)
              sys.exit(1)

            url = stanza.get("url")
            if not isinstance(url, str) or suffix not in url:
              print(f"Unexpected or missing url for {key}: {url!r}", file=sys.stderr)
              sys.exit(1)

            stanza["hash"] = f"sha256:{sha}"

          data["version"] = version

          with open(path, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2)
            f.write("\n")

          print("Patched", path)
          PY

          git diff -- "${MANIFEST_PATH}"

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_BREW_SCOOP_GITHUB_TOKEN }}
          path: bucketrepo
          commit-message: "kubeforward: bump to ${{ steps.meta.outputs.version }}"
          branch: "bump/kubeforward-${{ steps.meta.outputs.version }}"
          title: "kubeforward: bump to ${{ steps.meta.outputs.version }}"
          body: |
            Automated bump from GitHub Release:
            - Version: `${{ steps.meta.outputs.version }}`
            - windows-x64 sha256: `${{ steps.meta.outputs.sha_windows_x64 }}`
            - windows-arm64 sha256: `${{ steps.meta.outputs.sha_windows_arm64 }}`

            Release: ${{ steps.meta.outputs.release_url }}
