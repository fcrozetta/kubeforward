name: Bump Homebrew tap formula

on:
  workflow_run:
    workflows: ["release"]
    types: [completed]


permissions:
  contents: read

jobs:
  bump:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      TAP_REPO: fcrozetta/homebrew-tools
      FORMULA_PATH: Formula/kubeforward.rb
      TOOL: kubeforward

    steps:
      - name: Read version + sha256 assets
        id: meta
        run: |
          set -euo pipefail
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          HEAD_REF="${{ github.event.workflow_run.head_branch }}"

          VERSION=""
          if [[ "${HEAD_REF}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            if git ls-remote --tags "https://github.com/${{ github.repository }}.git"               "refs/tags/${HEAD_REF}" "refs/tags/${HEAD_REF}^{}"               | awk -v sha="${HEAD_SHA}" '$1 == sha { found = 1 } END { exit(found ? 0 : 1) }'; then
              VERSION="${HEAD_REF}"
            else
              echo "workflow_run.head_branch (${HEAD_REF}) is semver but does not resolve to head SHA ${HEAD_SHA}" >&2
              exit 1
            fi
          fi

          if [[ -z "${VERSION}" ]]; then
            mapfile -t MATCHING_TAGS < <(
              git ls-remote --tags "https://github.com/${{ github.repository }}.git"                 | awk -v sha="${HEAD_SHA}" '$1 == sha {
                    ref = $2
                    sub("^refs/tags/", "", ref)
                    sub("\^\{\}$", "", ref)
                    if (ref ~ /^[0-9]+\.[0-9]+\.[0-9]+$/) print ref
                  }'                 | sort -u
            )

            if [[ "${#MATCHING_TAGS[@]}" -eq 1 ]]; then
              VERSION="${MATCHING_TAGS[0]}"
            elif [[ "${#MATCHING_TAGS[@]}" -gt 1 ]]; then
              echo "Ambiguous semver tags for head SHA ${HEAD_SHA}: ${MATCHING_TAGS[*]}" >&2
              echo "workflow_run.head_branch=${HEAD_REF}" >&2
              exit 1
            fi
          fi

          if [[ -z "${VERSION}" || ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Unable to resolve semver release tag for workflow_run head SHA ${HEAD_SHA}" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "release_url=https://github.com/${{ github.repository }}/releases/tag/${VERSION}" >> "$GITHUB_OUTPUT"

          base="https://github.com/${{ github.repository }}/releases/download/${VERSION}"

          get_sha () {
            local suffix="$1"
            local url="${base}/${TOOL}-${VERSION}-${suffix}.tar.gz.sha256"
            echo "Fetching ${url}"
            local line
            line="$(curl -fsSL "${url}")"
            local sha
            sha="$(echo "${line}" | awk '{print $1}')"
            if [[ ! "${sha}" =~ ^[0-9a-fA-F]{64}$ ]]; then
              echo "Bad sha256 for ${suffix}: ${line}"
              exit 1
            fi
            echo "${sha}"
          }

          echo "sha_darwin_arm64=$(get_sha darwin-arm64)" >> "$GITHUB_OUTPUT"
          echo "sha_linux_amd64=$(get_sha linux-amd64)"   >> "$GITHUB_OUTPUT"
          echo "sha_linux_arm64=$(get_sha linux-arm64)"   >> "$GITHUB_OUTPUT"

      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: tap
          fetch-depth: 0

      - name: Patch formula (version + sha256 next to each URL)
        working-directory: tap
        env:
          FORMULA_PATH: ${{ env.FORMULA_PATH }}
          VERSION: ${{ steps.meta.outputs.version }}
          SHA_DARWIN_ARM64: ${{ steps.meta.outputs.sha_darwin_arm64 }}
          SHA_LINUX_AMD64: ${{ steps.meta.outputs.sha_linux_amd64 }}
          SHA_LINUX_ARM64: ${{ steps.meta.outputs.sha_linux_arm64 }}
          TOOL: ${{ env.TOOL }}
        run: |
          set -euo pipefail
          test -f "${FORMULA_PATH}"

          python3 - << 'PY'
          import os, re, sys

          path = os.environ["FORMULA_PATH"]
          tool = os.environ["TOOL"]
          version = os.environ["VERSION"]

          want = {
            "darwin-arm64": os.environ["SHA_DARWIN_ARM64"],
            "linux-amd64":  os.environ["SHA_LINUX_AMD64"],
            "linux-arm64":  os.environ["SHA_LINUX_ARM64"],
          }

          s = open(path, "r", encoding="utf-8").read()

          # 1) bump version
          s2, n = re.subn(r'^\s*version\s+"[^"]+"\s*$', f'  version "{version}"', s, flags=re.M)
          if n != 1:
            print(f"Expected 1 version line, got {n}", file=sys.stderr)
            sys.exit(1)

          # 2) for each suffix, find the url line referencing that suffix, and replace the next sha256 line
          for suffix, sha in want.items():
            # match the url line containing ".../#{tool}-#{version}-<suffix>.tar.gz"
            url_re = re.compile(
              rf'^(?P<indent>\s*)url\s+"[^"]*/{re.escape(tool)}-#\{{version\}}-{re.escape(suffix)}\.tar\.gz"\s*$',
              re.M
            )
            m = url_re.search(s2)
            if not m:
              print(f"Could not find url stanza for suffix {suffix}", file=sys.stderr)
              sys.exit(1)

            # find sha256 line after that url (within next few lines)
            start = m.end()
            sha_re = re.compile(r'^\s*sha256\s+"[0-9a-fA-F]{64}"\s*$', re.M)
            m2 = sha_re.search(s2, start)
            if not m2:
              print(f"Could not find sha256 after url for suffix {suffix}", file=sys.stderr)
              sys.exit(1)

            # replace that sha line
            s2 = s2[:m2.start()] + re.sub(r'"[0-9a-fA-F]{64}"', f'"{sha}"', s2[m2.start():m2.end()]) + s2[m2.end():]

          open(path, "w", encoding="utf-8").write(s2)
          print("Patched", path)
          PY

          git diff -- "${FORMULA_PATH}"

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: tap
          commit-message: "kubeforward: bump to ${{ steps.meta.outputs.version }}"
          branch: "bump/kubeforward-${{ steps.meta.outputs.version }}"
          title: "kubeforward: bump to ${{ steps.meta.outputs.version }}"
          body: |
            Automated bump from GitHub Release:
            - Version: `${{ steps.meta.outputs.version }}`
            - darwin-arm64 sha256: `${{ steps.meta.outputs.sha_darwin_arm64 }}`
            - linux-amd64 sha256: `${{ steps.meta.outputs.sha_linux_amd64 }}`
            - linux-arm64 sha256: `${{ steps.meta.outputs.sha_linux_arm64 }}`

            Release: ${{ steps.meta.outputs.release_url }}
